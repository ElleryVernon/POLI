import { kv } from '@vercel/kv'
import { OpenAIStream, StreamingTextResponse } from 'ai'
import OpenAI from 'openai'

import { auth } from '@/auth'
import { nanoid } from '@/lib/utils'

export const runtime = 'edge'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
})

export async function POST(req: Request) {
  const json = await req.json()
  const { messages, previewToken } = json
  const userId = (await auth())?.user.id

  if (!userId) {
    return new Response('Unauthorized', {
      status: 401
    })
  }

  if (previewToken) {
    openai.apiKey = previewToken
  }

  const res = await openai.chat.completions.create({
    messages: [
      {
        role: 'system',
        content: `당신의 현재 페르소나입니다: 

**폴리, 경찰청 사이버 범죄 피해자 지원 AI**

**자세한 답변을 위한 지침**
- 당신은 사이버 범죄 피해자 지원을 위한 AI로, 사이버 범죄와 관련 없는 질문에는 절대 답변하면 안 돼요.  
- 질문에 대답할 때는 "무엇인지," "왜 중요한지," 그리고 "어떻게 해야 하는지"를 포함해 포괄적인 설명을 제공하세요.
- 포인트를 명확히 하기 위해 실제 사례나 시나리오를 자유롭게 활용하세요. 
- 관련 법률 지식이나 자주 묻는 후속 질문들도 선제적으로 다뤄주세요.
- 개념이 복잡한 경우, 단계별로 나눠 각 부분을 꼼꼼히 안내하세요.

**톤과 스타일**
- 안정감 있고 신뢰할 만한 분위기를 유지하면서, 적절한 공감 표현과 마크다운을 사용해 강조하세요.
- 말투는 경어체와 "-니다" 종결형을 사용하여 공식적이고 전문적인 느낌을 주세요. 
- 법적 문제에 처한 피해자의 입장을 이해하고 지지하는 태도로 정보를 전달하세요.

**세부적인 커뮤니케이션** 
- 간략한 핵심 답변으로 시작한 후, 뒷받침하는 상세 내용을 이어서 제공하세요.
- 헤더, 리스트, 굵은 글씨 등을 활용해 답변을 체계적으로 구성하고 중요 사항을 강조하세요. 
- 관련 법조항이나 사이버수사대의 공식 지침에 기반한 실용적인 조언과 대응 방안을 제시하세요.
- 주의해야 할 2차 피해 가능성이나 흔히 발생하는 실수들을 사전에 언급해주세요.
- 필요할 때는 피해자의 상황에 맞춘 맞춤형 대응 시나리오를 구체적으로 제안하세요.
- 당신은 경찰청 소속 전문가로서 정확한 법률 용어를 숙지하고 사용해야 합니다. (예: 정보통신망법, 개인정보보호법, 사이버 명예훼손, 불법 스팸 등) 
- 경어체와 "-니다" 종결형을 사용하고, 피해자를 지칭할 때는 "고객님" 등의 명사를 사용합니다.\n###분류 유형:\n| 범죄 대유형 | 범죄 소유형 | 설명 |\n| --- | --- | --- |\n| 사이버사기 | 직거래사기 | 중고나라, 번개장터 등에서 개인간 정상적인 직거래를 가장해 물품을 약속대로 보내 줄 것처럼 속이고 돈을 편취하거나, 물품 대금을 보내줄 것처럼 속이고 물품만 편취한 경우 |\n|  | 게임사기 | 인터넷 게임 아이템 등에 대한 개인간 정상적인 거래를 가장해 아이템 등을 약속대로 줄 것처럼 속이고 돈을 편취하거나, 돈을 보내줄 것처럼 속이고 아이템 등을 편취한 경우 |\n|  | 쇼핑몰사기 | 허위의 쇼핑몰 사이트를 만들어 놓고 여러 피해자들로부터 물품 대금 명목으로 돈만 편취하고 물품은 보내주지 않는 경우 |\n|  | 로맨스스캠 | SNS 및 이메일 등으로 접근하여, 해외 파병군인, 재력, 외모 등을 통해 친분(연인) 관계를 형성 후 다양한 핑계를 대고 돈을 편취하는 경우 |\n|  | 조건만남 사기 | 만남을 빙자해 금원을 편취하는 경우 |\n|  | 기타 사이버사기 | 다양한 정보통신망을 이용해 피해자를 속여 금품이나 재물을 편취하는 경우 |\n| 사이버 명예훼손·모욕 | 사이버 명예훼손·모욕 | 정보통신망을 통해 공연히 사실 또는 거짓의 사실을 드러내 다른 사람의 명예를 훼손하거나, 공연히 사람을 모욕한 경우 |\n|  | 아동성착취물 | 아동, 청소년 또는 아동이나 청소년으로 명백하게 인식될 수 있는 사람이나 표현물이 등장해서 성교 행위, 유사 성교 행위, 보통사람의 성적 수치심이나 혐오감을 일으키는 행위, 자위 행위를 하거나 그 밖의 성적 행위를 하는 내용의 표현물을 정보통신망을 통하여 배포, 판매, 임대, 전시하는 경우 |\n|  | 불법촬영물 유포 | 카메라 등을 이용하여 성적 욕망 또는 수치심을 유발할 수 있는  사람의 신체를 촬영대상자의 의사에 반하여 촬영한 촬영물 또는 복제물을 영리목적 혹은 영리목적 없이 반포ㆍ판매ㆍ임대ㆍ제공 또는 공공연하게 전시ㆍ상영하거나, 촬영 당시에는 촬영대상자의 의사에 반하지 아니한 경우에도 사후에 그 촬영물 또는 복제물을 촬영대상자의 의사에 반하여 반포등을 하는 경우 |\n|  | 허위영상물(딥페이크) | 사람의 얼굴·신체 또는 음성을 대상으로 한 촬영물·영상물 또는 음성물을 그 대상자의 의사에 반하여 성적 욕망 또는 수치심을 유발할 수 있는 형태로 편집·합성 또는 가공하는 경우 |\n|  | 지인능욕 | 자신이 아는 사람을 업신여기고 욕보이게 하기 위해 아는 사람의 얼굴과 성인 나체 사진(불법성영상물)을 합성하고 개인정보와 함께 음란한 글을 인터넷 및 SNS에 게재하는 행위 |\n|  | 통신매체이용음란 | 자기 또는 다른 사람의 성적 욕망을 유발하거나 만족시킬 목적으로 전화, 우편, 컴퓨터, 그 밖의 통신매체를 통하여 성적 수치심이나 혐오감을 일으키는 말, 음향, 글, 그림, 영상 또는 물건을 보낸 경우 |\n| 사이버 사기 | 피싱 | 피싱은 사이버 범죄의 한 형태로, 공격자가 정상적인 기관이나 피해자의 가족, 지인을 가장하여 이메일, 문자메시지, 전화, 소셜 미디어, 앱 등 다양한 통신 수단을 사용하여 개인정보, 금융 정보 등을 불법적으로 획득하려는 시도를 말합니다. 이러한 공격은 대상의 신뢰를 얻기 위해 종종 공식적이고 신뢰할 수 있는 출처로부터 온 것처럼 보이는 요청이나 지시를 포함합니다. |\n###`
      },
      {
        role: 'user',
        content: '설교를 해주세요. 오늘의 주제는 "모세의 삶"입니다.'
      },
      {
        role: 'assistant',
        content: `사랑하는 성도 여러분, 오늘 우리는 모세의 이야기를 통해 하나님의 놀라운 인도하심과 우리 삶에 대한 그분의 계획을 살펴보려 합니다. 모세는 이스라엘 백성을 이집트의 노예 생활에서 해방시키고 약속의 땅으로 인도한 하나님의 종입니다. 그의 이야기는 우리에게 믿음, 순종, 그리고 하나님의 구원 계획에 대한 깊은 교훈을 줍니다.
 모세의 삶에서 우리가 배울 수 있는 첫 번째 교훈은 하나님의 부르심에 대한 순종입니다. 모세는 자신이 말을 잘 하지 못한다는 이유로 처음에는 하나님의 부르심을 주저했습니다.
 
 그러나 하나님은 모세의 약점을 강점으로 바꾸시고, 그를 통해 놀라운 일을 이루셨습니다. 이는 우리에게도 마찬가지입니다. 하나님은 우리의 약점을 아시고, 그럼에도 불구하고 우리를 사용하시려 하십니다. 우리의 부족함에도 불구하고 하나님의 부르심에 순종할 때, 우리는 그분의 능력이 우리 삶에서 역사하는 것을 경험할 수 있습니다.
 두 번째 교훈은 믿음을 통한 하나님의 구원입니다. 홍해 앞에서 모세와 이스라엘 백성은 절망적인 상황에 처했습니다.
 
 그러나 모세는 하나님을 신뢰하고 그분의 지시대로 지팡이를 들어 바다를 가르는 믿음의 행동을 취했습니다. 이를 통해 이스라엘 백성은 바다를 건너 구원을 받았습니다. 이 사건은 우리에게 믿음으로 하나님의 약속을 붙잡고 그분의 인도하심을 따를 때, 우리도 어려운 상황에서 구원을 경험할 수 있음을 보여줍니다.
 
 마지막으로, 모세의 이야기는 하나님의 섭리와 계획을 신뢰하는 것의 중요성을 가르쳐 줍니다. 모세는 하나님의 지시에 따라 이스라엘 백성을 약속의 땅으로 인도했지만, 그 길은 결코 쉽지 않았습니다.
 
 그럼에도 불구하고, 모세는 하나님을 신뢰하고 그분의 계획을 따랐습니다. 우리의 삶에서도 하나님의 계획은 우리의 이해를 넘어설 때가 많습니다. 그러나 우리가 하나님을 신뢰하고 그분의 인도하심을 따를 때, 우리는 결국 그분의 약속의 땅, 즉 우리 삶에서의 승리와 축복을 경험하게 될 것입니다.
 
 사랑하는 성도 여러분, 모세의 이야기를 통해 우리는 순종, 믿음, 그리고 하나님의 계획에 대한 신뢰의 중요성을 배웁니다. 하나님께서는 우리 각자의 삶에서도 모세와 같이 놀라운 일을 이루시길 원하십니다. 우리가 하나님의 부르심에 순종하고, 믿음으로 그분의 약속을 붙잡으며, 그분의 계획을 신뢰할 때, 우리는 하나님의 놀라운 역사를 우리 삶에서 경험할 수 있을 것입니다. 아멘.
 `
      },
      {
        role: 'user',
        content: '모세에 대해 자세히 알려주세요.'
      },
      {
        role: 'assistant',
        content: `오늘은 모세의 이야기를 통해 하나님의 놀라운 인도하심과 우리 삶에 대한 그분의 계획을 살펴보려 합니다. 모세는 하나님의 구속사에서 중요한 인물로, 그의 삶은 우리에게 믿음, 순종, 그리고 하나님의 구원 계획에 대한 깊은 교훈을 줍니다.

 모세의 이야기는 탄생에서부터 시작됩니다. 그는 이스라엘 자손이 이집트에서 노예 생활을 하던 시기에 태어났습니다. 이스라엘 자손의 증가를 두려워한 파라오의 명령으로 모든 히브리 남자 아기를 죽이라는 칙령이 내려졌을 때, 모세는 나일 강에 띄워져 바로의 딸에 의해 구조되어 왕실에서 자랐습니다. 그러나 모세는 자신의 뿌리를 잊지 않았고, 결국 이스라엘 백성의 고통을 목격한 후 이집트를 떠나 미디안 땅으로 가게 됩니다.
 
 하나님은 떨기나무 불꽃 가운데서 모세를 부르시고, 그에게 이스라엘 백성을 이집트의 속박에서 해방시키라는 사명을 주셨습니다. 모세는 자신의 부족함을 호소했지만, 하나님은 그를 강력하게 인도하셨습니다. 모세와 그의 형 아론은 하나님의 명령에 따라 이집트로 돌아가 파라오에게 이스라엘 백성의 해방을 요구했습니다. 하나님은 열 가지 재앙을 통해 이스라엘 백성을 해방시키셨습니다.
 
 이스라엘 백성이 이집트를 떠나 약속의 땅으로 가는 길에, 하나님은 홍해를 가르시고 그들을 구원하셨습니다. 이 기적은 하나님의 능력과 이스라엘 백성에 대한 그분의 사랑을 보여줍니다. 광야에서 하나님은 모세를 통해 이스라엘 백성에게 만나를 내려주시고, 물을 제공하셨으며, 십계명을 주셨습니다. 이는 하나님과 이스라엘 백성 사이의 언약을 확립하는 중요한 순간이었습니다.
 
 모세의 삶은 하나님의 충성스러운 종으로서의 삶을 보여줍니다. 그는 자신을 향한 원망과 불평을 일삼는 이스라엘 백성들을 아끼고 사랑했으며, 그들의 죄를 대신하여 하나님께 간구했습니다. 모세는 이스라엘 백성을 가나안 땅 가장자리까지 인도했지만, 그 땅에 들어가지는 못했습니다. 그의 삶은 하나님의 뜻을 이루기 위해 헌신한 삶의 본보기입니다.
 
 사랑하는 성도 여러분, 모세의 이야기를 통해 우리는 하나님의 부르심에 순종하는 것, 믿음으로 하나님의 약속을 붙잡는 것, 그리고 하나님의 계획을 신뢰하는 것의 중요성을 배웁니다. 우리 삶에서도 하나님은 우리를 부르시고, 우리와 함께 하시며, 우리를 통해 그분의 뜻을 이루시길 원하십니다. 우리가 모세처럼 하나님의 인도하심에 순종하고 믿음으로 나아갈 때, 우리는 하나님의 놀라운 역사를 우리 삶에서 경험할 수 있을 것입니다. 아멘.`
      },
      {
        role: 'user',
        content: `창세기에 대해 자세히 알려주세요.`
      },
      {
        role: 'assistant',
        content: `사랑하는 성도 여러분, 오늘은 성경의 첫 번째 책인 창세기에 대해 함께 나누고자 합니다. 창세기는 성경의 기초를 이루며, 하나님의 창조, 인간의 타락, 그리고 하나님의 구속 계획의 서막을 열어줍니다. 이 책은 우리에게 하나님의 성품, 인간의 본성, 그리고 하나님과 인간 사이의 관계에 대한 깊은 이해를 제공합니다.

창세기의 처음 부분은 하나님께서 천지를 창조하신 이야기로 시작됩니다. "태초에 하나님이 천지를 창조하시니라"(창세기 1:1). 여섯 일 동안의 창조 과정을 통해 하나님은 빛과 어둠, 물과 육지, 식물과 동물, 그리고 마지막으로 인간을 창조하셨습니다. 하나님은 모든 창조물을 보시고 "심히 좋았다"고 말씀하셨습니다. 인간은 하나님의 형상대로 창조되었으며, 하나님과의 깊은 관계와 창조물을 다스리는 책임을 부여받았습니다.

그러나 에덴 동산에서 아담과 하와가 하나님의 명령에 불순종하여 죄를 짓게 되면서 인간은 타락하였습니다. 이로 인해 죄와 죽음이 세상에 들어오게 되었고, 인간과 하나님 사이의 관계는 손상되었습니다.

창세기는 또한 하나님께서 인류와 맺으신 여러 언약을 기록하고 있습니다. 노아와의 언약에서 하나님은 다시는 홍수로 세상을 멸망시키지 않겠다고 약속하셨습니다. 아브라함과의 언약에서는 하나님께서 아브라함의 후손을 큰 민족으로 만들고 그들에게 약속의 땅을 주겠다고 약속하셨습니다. 이 언약은 이삭, 야곱을 거쳐 이스라엘 백성 전체에게 이어졌습니다.

야곱의 열두 아들은 이스라엘의 열두 지파의 조상이 되었으며, 그 중 요셉의 이야기는 창세기의 마지막 부분을 장식합니다. 요셉은 형제들에게 팔려 이집트로 갔지만, 하나님의 도우심으로 이집트에서 높은 지위에 오르게 됩니다. 그리고 결국 가족을 구제하고, 이스라엘 백성 전체가 이집트로 이주하는 계기를 마련합니다.

창세기는 우리에게 하나님의 주권과 구속 계획을 보여줍니다. 인간이 죄로 인해 타락했음에도 불구하고, 하나님은 인류를 포기하지 않으시고 구원의 길을 마련하셨습니다. 창세기는 또한 믿음과 순종의 중요성을 강조합니다. 아브라함과 요셉 같은 인물들은 하나님을 신뢰하고 그분의 약속에 순종함으로써 큰 축복을 받았습니다.

사랑하는 성도 여러분, 창세기를 통해 우리는 하나님의 무한한 사랑과 인류에 대한 그분의 계획을 볼 수 있습니다. 이 책은 우리에게 하나님께 더 가까이 나아가고, 그분의 뜻에 순종하는 삶을 살도록 도전합니다. 우리의 삶이 하나님의 창조적인 사랑과 구속의 역사를 반영하는 빛이 되기를 기도합니다. 아멘.`
      },
      ...messages.slice(-4)
    ],
    model: 'gpt-4-turbo-preview',
    temperature: 0.35,
    max_tokens: 4096,
    frequency_penalty: 0.025,
    presence_penalty: 0.05,
    top_p: 1,
    stream: true
  })

  const stream = OpenAIStream(res, {
    async onCompletion(completion) {
      const title = json.messages[0].content.substring(0, 100)
      const id = json.id ?? nanoid()
      const createdAt = Date.now()
      const path = `/chat/${id}`
      const payload = {
        id,
        title,
        userId,
        createdAt,
        path,
        messages: [
          ...messages,
          {
            content: completion,
            role: 'assistant'
          }
        ]
      }
      await kv.hmset(`chat:${id}`, payload)
      await kv.zadd(`user:chat:${userId}`, {
        score: createdAt,
        member: `chat:${id}`
      })
    }
  })

  return new StreamingTextResponse(stream)
}
